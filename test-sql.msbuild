<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="BuildDatabase">

  	<PropertyGroup>
		<SQLServer Condition="'$(SQLServer)'==''">localhost</SQLServer>
		<SQLServerUser Condition="'$(SQLServerUser)'==''">SA</SQLServerUser>
		<SQLServerPassword Condition="'$(SQLServerPassword)'==''">MyPass@word</SQLServerPassword>
		<SQLServerDataPath Condition="'$(SQLServerDataPath)'==''">$(MSBuildThisFileDirectory)sqldata</SQLServerDataPath>
		<SQLImage Condition="'$(SQLImage)'==''">mcr.microsoft.com/azure-sql-edge</SQLImage>
		<SQLContainerName Condition="'$(SQLContainerName)'==''">sqltest</SQLContainerName>
		<DockerNetworkName>kb-builder-net</DockerNetworkName>
  	</PropertyGroup>

	<Target Name="BuildDatabase" DependsOnTargets="RunSqlContainer;CreateDatabase;StopSqlContainer;CopyMdfFiles;ListMdfFiles" />

	<Target Name="InstallSqlCmd" Condition="!Exists('/opt/mssql-tools18/bin/sqlcmd')">
		<Message Text="Installing mssql-tools18..." Importance="High" />
		<Exec Command="apt-get update" />
		<Exec Command="apt-get install -y curl apt-transport-https gnupg" />
		<Exec Command="curl -sSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /usr/share/keyrings/microsoft.gpg" />
		<Exec Command="echo 'deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/debian/12/prod bookworm main' > /etc/apt/sources.list.d/mssql-release.list" />
		<Exec Command="apt-get update" />
		<Exec Command="ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev" />
	</Target>

	<Target Name="RunSqlContainer" DependsOnTargets="InstallSqlCmd">
		<Exec Command="bash -c '
			set -e
			set -x

			# Step 1: Get the ID/hostname of the current (builder) container.
			MY_CONTAINER_ID=$(hostname)

			# Step 2: Inspect this container to find the name of the network it is attached to.
			MY_NETWORK_NAME=$(docker inspect --format=&quot;{{range $$k, $$v := .NetworkSettings.Networks}}{{$$k}}{{end}}&quot; $$MY_CONTAINER_ID)

			# Step 3: Print the discovered values for debugging.
			echo &quot;--- Discovered Network Info ---&quot;
			echo &quot;Builder Container ID: $$MY_CONTAINER_ID&quot;
			echo &quot;Attaching to Network: $$MY_NETWORK_NAME&quot;
			echo &quot;-----------------------------&quot;

			# Step 4: Launch the SQL container on the discovered network.
			docker run -d --rm --name $(SQLContainerName) --network=$$MY_NETWORK_NAME -e ACCEPT_EULA=Y -e SA_PASSWORD=$(SQLServerPassword) $(SQLImage)
		'" />

		<Message Text="Waiting for SQL Server to be ready..." Importance="High" />
		<Exec Command="./wait-for-sql.sh $(SQLContainerName) $(SQLContainerName) $(SQLServerUser) $(SQLServerPassword)" />
	</Target>

	<Target Name="StopSqlContainer">
		<Message Text="Stopping SQL container..." Importance="High" />
		<Exec Command="docker stop $(SQLContainerName)" IgnoreExitCode="true" />
		<Exec Command="docker network disconnect $(DockerNetworkName) $(SQLContainerName)" />
		<Exec Command="docker network rm $(DockerNetworkName)" />
	</Target>

	<Target Name="CreateDatabase" DependsOnTargets="InstallSqlCmd">
		<Message Text="Creating TestDB..." Importance="High" />
		<Exec Command="$(MSBuildThisFileDirectory)/opt/mssql-tools18/bin/sqlcmd -S $(SQLContainerName) -U $(SQLServerUser) -P &quot;$(SQLServerPassword)&quot; -C -Q &quot;CREATE DATABASE TestDB&quot;" />
		<Exec Command="/opt/mssql-tools18/bin/sqlcmd -S $(SQLContainerName) -U $(SQLServerUser) -P &quot;$(SQLServerPassword)&quot; -C -Q &quot;SELECT name FROM sys.databases&quot;" />
	</Target>

	<Target Name="CopyMdfFiles">
		<Message Text="Creating local directory to store database files..." Importance="High" />
		<Exec Command="docker cp &quot;$(SQLContainerName):/var/opt/mssql/data/GX_KB_Base.mdf&quot; &quot;$(KBPath)&quot;" />
		<Exec Command="docker cp &quot;$(SQLContainerName):/var/opt/mssql/data/GX_KB_Base_log.ldf&quot; &quot;$(KBPath)&quot;" />
	</Target>

	<Target Name="ListMdfFiles">
		<Message Text="Listing MDF/LDF files in $(KBPath)" Importance="High" />
		<Exec Command="ls -l $(KBPath)" />
	</Target>

</Project>
