<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="BuildDatabase">

  <PropertyGroup>
		<SQLServer Condition="'$(SQLServer)'==''">localhost</SQLServer>
		<SQLServerUser Condition="'$(SQLServerUser)'==''">SA</SQLServerUser>
		<SQLServerPassword Condition="'$(SQLServerPassword)'==''">MyPass@word</SQLServerPassword>
		<SQLServerDataPath Condition="'$(SQLServerDataPath)'==''">$(MSBuildThisFileDirectory)sqldata</SQLServerDataPath>
		<SQLImage Condition="'$(SQLImage)'==''">mcr.microsoft.com/azure-sql-edge</SQLImage>
		<SQLContainerName Condition="'$(SQLContainerName)'==''">sqltest</SQLContainerName>
  </PropertyGroup>

  <Target Name="BuildDatabase" DependsOnTargets="RunSqlContainer;CreateDatabase;StopSqlContainer;ListMdfFiles" />

  <Target Name="InstallSqlCmd" Condition="!Exists('/opt/mssql-tools18/bin/sqlcmd')">
    <Message Text="Installing mssql-tools18..." Importance="High" />
    <Exec Command="sudo apt-get update" />
    <Exec Command="sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev" />
  </Target>

	<Target Name="RunSqlContainer" DependsOnTargets="InstallSqlCmd">
		<Message Text="Starting SQL Edge container..." Importance="High" />
		<Exec Command="docker run -d --rm --name $(SQLContainerName) -e ACCEPT_EULA=Y -e SA_PASSWORD=$(SQLServerPassword) -p 1433:1433 -v $(SQLServerDataPath):/var/opt/mssql/data --user root $(SQLImage)" />

		<Message Text="Waiting for SQL Server to be ready..." Importance="High" />
		<Exec Command="bash -c &quot;
      echo '⏳ Initial sleep (10s)...';
      sleep 10;
      i=1;
      while [ \$i -le 30 ]; do
        if docker exec $(SQLContainerName) /bin/bash -c 'timeout 1 bash -c &quot;&amp;lt; /dev/tcp/localhost/1433&quot; 2&amp;gt;/dev/null'; then
          echo '✅ SQL Server port 1433 is open';
          exit 0;
        fi;
        echo &quot;⏳ Waiting for SQL Server to start (\$i/30)...&quot;;
        sleep 2;
        i=`expr \$i + 1`;
      done;
      echo '❌ SQL Server did not start in time';
      docker logs $(SQLContainerName);
      exit 1;
    &quot;" />
	</Target>

	<Target Name="StopSqlContainer">
		<Message Text="Stopping SQL container..." Importance="High" />
		<Exec Command="docker stop $(SQLContainerName)" IgnoreExitCode="true" />
	</Target>

	<Target Name="CreateDatabase" DependsOnTargets="InstallSqlCmd">
    <Message Text="Creating TestDB..." Importance="High" />
    <Exec Command="/opt/mssql-tools18/bin/sqlcmd -S $(SQLServer) -U sa -P &quot;$(SQLServerPassword)&quot; -C -Q &quot;CREATE DATABASE TestDB&quot;" />
    <Exec Command="/opt/mssql-tools18/bin/sqlcmd -S $(SQLServer) -U sa -P &quot;$(SQLServerPassword)&quot; -C -Q &quot;SELECT name FROM sys.databases&quot;" />
  </Target>

  <Target Name="ListMdfFiles">
    <Message Text="Listing MDF/LDF files in $(SQLServerDataPath)" Importance="High" />
    <Exec Command="ls -l $(SQLServerDataPath)" />
  </Target>

</Project>